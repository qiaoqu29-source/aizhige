<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æˆ‘çš„è™šæ‹Ÿæ‰‹æœº</title>
    <style>
        :root {
            --primary-color: #007AFF;
            --desktop-bg: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * {
            margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            height: 100vh; overflow: hidden; background: #000;
        }

        /* === 1. æ¡Œé¢å±‚ === */
        .desktop-layer {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--desktop-bg); z-index: 1;
            display: flex; flex-direction: column; padding: 20px;
        }

        .status-widget { margin-top: 40px; text-align: center; color: #333; text-shadow: 0 1px 2px rgba(255,255,255,0.5); }
        .clock-time { font-size: 64px; font-weight: 200; }
        .clock-date { font-size: 18px; margin-top: 5px; }

        .app-grid { margin-top: 40px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .app-item { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; }
        .app-item:active .app-icon { transform: scale(0.9); filter: brightness(0.8); }
        .app-icon {
            width: 60px; height: 60px; border-radius: 14px; display: flex; align-items: center; justify-content: center;
            font-size: 30px; background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: all 0.2s;
        }
        .icon-chat { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; }
        .icon-settings { background: linear-gradient(135deg, #434343 0%, black 100%); color: white; }
        .app-name { font-size: 12px; color: #333; text-shadow: 0 1px 1px white; }

        /* === 2. é€šç”¨åº”ç”¨çª—å£ === */
        .app-window {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: #F2F2F7; z-index: 10;
            display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .app-window.open { transform: translateY(0); }

        .nav-bar {
            height: 50px; background: white; display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; border-bottom: 1px solid #c6c6c8; flex-shrink: 0; z-index: 50;
        }
        .nav-title { font-weight: 600; font-size: 17px; }
        .nav-btn { border: none; background: none; color: var(--primary-color); font-size: 16px; font-weight: 500; cursor: pointer; }
        .nav-btn.icon-btn { font-size: 20px; padding: 0 5px; }

        .content-scroll { flex: 1; overflow-y: auto; padding: 15px; }

        /* === 3. èŠå¤©è¯¦æƒ…å±‚ (ä¾§æ»‘) === */
        .chat-detail-layer {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: #fff; z-index: 20;
            display: flex; flex-direction: column;
            transform: translateX(100%); transition: transform 0.3s ease;
        }
        .chat-detail-layer.open { transform: translateX(0); }

        /* èŠå¤©æ°”æ³¡ */
        .msg-row { display: flex; margin-bottom: 15px; flex-direction: column; }
        .msg-row.user { align-items: flex-end; }
        .msg-row.ai { align-items: flex-start; }
        
        .msg-bubble { 
            max-width: 80%; padding: 10px 14px; border-radius: 18px; font-size: 16px; word-wrap: break-word; position: relative;
        }
        .msg-row.ai .msg-bubble { background: #E9E9EB; color: black; border-bottom-left-radius: 4px; }
        .msg-row.user .msg-bubble { background: #007AFF; color: white; border-bottom-right-radius: 4px; }
        
        /* å›¾ç‰‡æ¶ˆæ¯æ ·å¼ */
        .msg-img { max-width: 200px; border-radius: 12px; margin-bottom: 5px; display: block; cursor: pointer; }

        /* åº•éƒ¨è¾“å…¥åŒºåŸŸ */
        .chat-footer {
            background: #f9f9f9; border-top: 1px solid #c6c6c8; padding-bottom: var(--safe-bottom);
        }
        .input-bar { padding: 8px 10px; display: flex; align-items: flex-end; gap: 10px; }
        
        .tool-btn { 
            width: 36px; height: 36px; border-radius: 50%; border: 1px solid #ccc; background: white; 
            color: #555; font-size: 20px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        }
        .chat-input { 
            flex: 1; padding: 9px 12px; border-radius: 18px; border: 1px solid #ddd; outline: none; 
            font-size: 16px; max-height: 100px; background: white;
        }
        .send-btn { 
            background: var(--primary-color); color: white; border: none; padding: 0 15px; height: 36px; 
            border-radius: 18px; font-weight: 600; font-size: 15px; flex-shrink: 0;
        }

        /* å·¥å…·æ é¢æ¿ */
        .tools-panel {
            height: 0; overflow: hidden; transition: height 0.2s ease; background: #f0f0f0;
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 0 20px;
        }
        .tools-panel.open { height: 120px; padding: 20px; }
        
        .tool-item { display: flex; flex-direction: column; align-items: center; gap: 5px; color: #666; font-size: 12px; }
        .tool-icon-box {
            width: 50px; height: 50px; background: white; border-radius: 12px; display: flex; 
            align-items: center; justify-content: center; font-size: 24px;
        }

        /* === 4. è®¾ç½®ä¸åˆ—è¡¨é€šç”¨ === */
        .char-item {
            background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px;
            display: flex; align-items: center; gap: 15px;
        }
        .char-avatar { 
            width: 45px; height: 45px; border-radius: 50%; background: #007AFF; color: white; 
            display: flex; align-items: center; justify-content: center; font-size: 20px;
        }
        
        .setting-input {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; background: white;
            font-size: 16px; font-family: inherit;
        }
        .setting-label { color:#666; margin-bottom:5px; font-size: 14px; }
        .model-row { display: flex; gap: 8px; margin-bottom: 15px; }
        .fetch-btn {
            background:#EFEFF4; border:1px solid #ddd; border-radius:8px; padding:0 15px;
            color: var(--primary-color); font-weight:600; font-size: 14px;
        }

        /* === 5. æ¨¡æ€æ¡† === */
        .modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 100;
            display: none; align-items: center; justify-content: center;
        }
        .modal.show { display: flex; }
        .modal-box { background: white; width: 85%; max-width: 320px; padding: 20px; border-radius: 16px; }
        .modal-btns { display: flex; gap: 10px; margin-top: 15px; }
        .modal-btn { flex: 1; padding: 12px; border-radius: 8px; border: none; font-size: 16px; cursor: pointer; }
        .btn-cancel { background: #f2f2f2; color: #333; }
        .btn-ok { background: #007AFF; color: white; }

        .home-indicator {
            position: fixed; bottom: 8px; left: 50%; transform: translateX(-50%);
            width: 120px; height: 5px; background: rgba(0,0,0,0.2); border-radius: 10px; z-index: 999; pointer-events: none;
        }
        
        /* éšè—çš„æ–‡ä»¶è¾“å…¥æ¡† */
        #file-input-image, #file-input-file { display: none; }
    </style>
</head>
<body>

    <!-- 1. æ¡Œé¢ -->
    <div class="desktop-layer" id="desktop">
        <div class="status-widget">
            <div class="clock-time" id="clock">12:00</div>
            <div class="clock-date" id="date">1æœˆ1æ—¥ æ˜ŸæœŸä¸€</div>
        </div>
        <div class="app-grid">
            <div class="app-item" id="icon-chat">
                <div class="app-icon icon-chat">ğŸ’¬</div>
                <div class="app-name">èŠå¤©</div>
            </div>
            <div class="app-item" id="icon-settings">
                <div class="app-icon icon-settings">âš™ï¸</div>
                <div class="app-name">è®¾ç½®</div>
            </div>
        </div>
        <div class="home-indicator"></div>
    </div>

    <!-- 2. åº”ç”¨ï¼šèŠå¤©åˆ—è¡¨ -->
    <div class="app-window" id="app-chat-list">
        <div class="nav-bar">
            <button class="nav-btn" onclick="goHome()">è¿”å›</button>
            <div class="nav-title">æ¶ˆæ¯</div>
            <button class="nav-btn icon-btn" onclick="openCreateModal()">+</button>
        </div>
        <div class="content-scroll" id="char-list-container"></div>
    </div>

    <!-- 3. åº”ç”¨ï¼šAPIè®¾ç½® -->
    <div class="app-window" id="app-settings">
        <div class="nav-bar">
            <button class="nav-btn" onclick="goHome()">è¿”å›</button>
            <div class="nav-title">è®¾ç½®</div>
            <div></div>
        </div>
        <div class="content-scroll">
            <p class="setting-label">API åœ°å€</p>
            <input type="text" class="setting-input" id="api-url" placeholder="https://api.example.com/v1/chat/completions">
            <p class="setting-label">API Key</p>
            <input type="password" class="setting-input" id="api-key" placeholder="sk-...">
            <p class="setting-label">æ¨¡å‹åç§° (å¦‚ gpt-4o æ”¯æŒå›¾ç‰‡)</p>
            <div class="model-row">
                <div style="flex:1" id="model-input-wrapper">
                    <input type="text" class="setting-input" id="model-name" placeholder="gpt-4o" style="margin-bottom:0">
                </div>
                <button class="fetch-btn" id="fetch-models-btn" onclick="fetchModels()">ğŸ”„ è·å–</button>
            </div>
            <button class="modal-btn btn-ok" style="width:100%" onclick="saveSettings()">ä¿å­˜é…ç½®</button>
        </div>
    </div>

    <!-- 4. èŠå¤©è¯¦æƒ…é¡µ -->
    <div class="chat-detail-layer" id="app-chat-detail">
        <div class="nav-bar">
            <button class="nav-btn" onclick="closeChat()">â® åˆ—è¡¨</button>
            <div class="nav-title" id="chat-title">åå­—</div>
            <!-- å³ä¸Šè§’è®¾ç½®æŒ‰é’® -->
            <button class="nav-btn icon-btn" onclick="openEditModal()">âš™ï¸</button>
        </div>
        <div class="content-scroll" id="msg-container"></div>
        <div class="chat-footer">
            <div class="input-bar">
                <button class="tool-btn" onclick="toggleTools()">+</button>
                <input type="text" class="chat-input" id="msg-input" placeholder="å‘æ¶ˆæ¯...">
                <button class="send-btn" onclick="sendMsg()">å‘é€</button>
            </div>
            <!-- æ›´å¤šåŠŸèƒ½é¢æ¿ -->
            <div class="tools-panel" id="tools-panel">
                <div class="tool-item" onclick="triggerFile('image')">
                    <div class="tool-icon-box">ğŸ–¼ï¸</div>
                    <span>ç›¸å†Œ</span>
                </div>
                <div class="tool-item" onclick="triggerFile('file')">
                    <div class="tool-icon-box">ğŸ“„</div>
                    <span>æ–‡ä»¶</span>
                </div>
            </div>
        </div>
    </div>

    <!-- éšè—æ–‡ä»¶è¾“å…¥ -->
    <input type="file" id="file-input-image" accept="image/*">
    <input type="file" id="file-input-file" accept=".txt,.md,.js,.html,.css,.json,.py">

    <!-- 5. æ¨¡æ€æ¡† (åˆ›å»º/ç¼–è¾‘ å…±ç”¨) -->
    <div class="modal" id="common-modal">
        <div class="modal-box" onclick="event.stopPropagation()">
            <h3 style="text-align:center; margin-bottom:15px" id="modal-heading">è§’è‰²ä¿¡æ¯</h3>
            <input type="text" class="setting-input" id="modal-char-name" placeholder="åå­—" onclick="event.stopPropagation()">
            <!-- æ”¹æˆtextareaæ–¹ä¾¿å†™é•¿Prompt -->
            <textarea class="setting-input" id="modal-char-prompt" placeholder="äººè®¾/æç¤ºè¯ (ç³»ç»ŸæŒ‡ä»¤)" rows="6" onclick="event.stopPropagation()"></textarea>
            <div class="modal-btns">
                <button class="modal-btn btn-cancel" id="btn-modal-cancel">å–æ¶ˆ</button>
                <button class="modal-btn btn-ok" id="btn-modal-ok">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- ç®€æ˜“ç”»å¸ƒç”¨äºå‹ç¼©å›¾ç‰‡ -->
    <canvas id="compress-canvas" style="display:none"></canvas>

    <script>
        let characters = [];
        let curChatId = null;
        let settings = {};
        let modalMode = 'create'; // 'create' or 'edit'

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            initUI();
            
            // æ—¶é’Ÿ
            setInterval(updateClock, 1000);
            updateClock();
        });

        function loadData() {
            characters = JSON.parse(localStorage.getItem('characters') || '[]');
            settings = JSON.parse(localStorage.getItem('settings') || '{"apiUrl":"","apiKey":"","modelName":"gpt-4o"}');
            document.getElementById('api-url').value = settings.apiUrl || '';
            document.getElementById('api-key').value = settings.apiKey || '';
            document.getElementById('model-name').value = settings.modelName || 'gpt-4o';
            renderList();
        }

        function initUI() {
            // æ¡Œé¢ç‚¹å‡»
            document.getElementById('icon-chat').onclick = () => openApp('app-chat-list');
            document.getElementById('icon-settings').onclick = () => openApp('app-settings');

            // æ¨¡æ€æ¡†
            document.getElementById('common-modal').onclick = (e) => { if(e.target.id==='common-modal') hideModal(); };
            document.getElementById('btn-modal-cancel').onclick = (e) => { e.stopPropagation(); hideModal(); };
            document.getElementById('btn-modal-ok').onclick = (e) => { e.stopPropagation(); handleModalOk(); };

            // æ–‡ä»¶é€‰æ‹©ç›‘å¬
            document.getElementById('file-input-image').onchange = (e) => handleImageSelect(e);
            document.getElementById('file-input-file').onchange = (e) => handleFileSelect(e);
        }

        // === å¯¼èˆªä¸UI ===
        function openApp(appId) {
            document.getElementById(appId).classList.add('open');
            if(appId === 'app-chat-list') renderList();
        }
        function goHome() {
            document.querySelectorAll('.app-window').forEach(el => el.classList.remove('open'));
            document.getElementById('app-chat-detail').classList.remove('open');
        }
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            const days = ['æ˜ŸæœŸæ—¥','æ˜ŸæœŸä¸€','æ˜ŸæœŸäºŒ','æ˜ŸæœŸä¸‰','æ˜ŸæœŸå››','æ˜ŸæœŸäº”','æ˜ŸæœŸå…­'];
            document.getElementById('date').innerText = `${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ ${days[now.getDay()]}`;
        }

        // === è§’è‰²ç®¡ç† ===
        function renderList() {
            const list = document.getElementById('char-list-container');
            list.innerHTML = '';
            if(characters.length === 0) {
                list.innerHTML = '<div style="text-align:center;color:#999;margin-top:50px">æš‚æ— è§’è‰²ï¼Œç‚¹å³ä¸Šè§’ + åˆ›å»º</div>';
                return;
            }
            characters.forEach(c => {
                const div = document.createElement('div');
                div.className = 'char-item';
                div.onclick = () => openChat(c.id);
                // é¢„è§ˆæœ€åä¸€æ¡æ–‡æœ¬
                let lastMsg = 'æ–°å¯¹è¯';
                if(c.messages.length > 0) {
                    const last = c.messages[c.messages.length - 1];
                    // å¦‚æœå†…å®¹æ˜¯æ•°ç»„(å¤šæ¨¡æ€)ï¼Œå°è¯•æ‰¾æ–‡æœ¬
                    if(Array.isArray(last.content)) {
                        const txt = last.content.find(i=>i.type==='text');
                        lastMsg = txt ? txt.text : '[å›¾ç‰‡/æ–‡ä»¶]';
                    } else {
                        lastMsg = last.content;
                    }
                }
                div.innerHTML = `
                    <div class="char-avatar">${c.name[0]}</div>
                    <div style="flex:1">
                        <div style="font-weight:600">${c.name}</div>
                        <div style="font-size:13px;color:#888;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;width:200px">${lastMsg}</div>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        // æ¨¡æ€æ¡†é€»è¾‘ (åˆ›å»º/ç¼–è¾‘)
        function openCreateModal() {
            modalMode = 'create';
            document.getElementById('modal-heading').innerText = 'åˆ›å»ºæ–°è§’è‰²';
            document.getElementById('modal-char-name').value = '';
            document.getElementById('modal-char-prompt').value = '';
            document.getElementById('common-modal').classList.add('show');
        }
        function openEditModal() {
            if(!curChatId) return;
            const char = characters.find(c => c.id === curChatId);
            modalMode = 'edit';
            document.getElementById('modal-heading').innerText = 'ä¿®æ”¹äººè®¾';
            document.getElementById('modal-char-name').value = char.name;
            document.getElementById('modal-char-prompt').value = char.prompt;
            document.getElementById('common-modal').classList.add('show');
        }
        function hideModal() { document.getElementById('common-modal').classList.remove('show'); }
        
        function handleModalOk() {
            const name = document.getElementById('modal-char-name').value.trim();
            const prompt = document.getElementById('modal-char-prompt').value.trim();
            if(!name) return alert('è¯·å¡«å†™åå­—');

            if(modalMode === 'create') {
                characters.unshift({ id: Date.now(), name, prompt, messages: [] });
                renderList();
            } else {
                // ç¼–è¾‘æ¨¡å¼
                const char = characters.find(c => c.id === curChatId);
                char.name = name;
                char.prompt = prompt;
                // æ›´æ–°å½“å‰æ ‡é¢˜
                document.getElementById('chat-title').innerText = name;
            }
            localStorage.setItem('characters', JSON.stringify(characters));
            hideModal();
        }

        // === èŠå¤©é€»è¾‘ ===
        function openChat(id) {
            curChatId = id;
            const char = characters.find(c => c.id === id);
            document.getElementById('chat-title').innerText = char.name;
            renderMsg(char);
            document.getElementById('app-chat-detail').classList.add('open');
            document.getElementById('tools-panel').classList.remove('open'); // é»˜è®¤å…³é—­å·¥å…·æ 
        }
        function closeChat() {
            document.getElementById('app-chat-detail').classList.remove('open');
            curChatId = null;
            renderList();
        }
        function toggleTools() {
            document.getElementById('tools-panel').classList.toggle('open');
        }

        // æ¸²æŸ“æ¶ˆæ¯
        function renderMsg(char) {
            const con = document.getElementById('msg-container');
            con.innerHTML = '';
            char.messages.forEach(m => {
                const div = document.createElement('div');
                div.className = `msg-row ${m.role === 'user' ? 'user' : 'ai'}`;
                
                let contentHtml = '';
                // å¤„ç†æ–‡æœ¬ (å…¼å®¹æ—§æ•°æ®å­—ç¬¦ä¸²å’Œæ–°æ•°æ®æ•°ç»„)
                if(typeof m.content === 'string') {
                    contentHtml = escapeHtml(m.content);
                } else if(Array.isArray(m.content)) {
                    m.content.forEach(item => {
                        if(item.type === 'text') contentHtml += `<div>${escapeHtml(item.text)}</div>`;
                        if(item.type === 'image_url') contentHtml += `<img src="${item.image_url.url}" class="msg-img" onclick="showBigImg(this.src)">`;
                    });
                }
                
                div.innerHTML = `<div class="msg-bubble">${contentHtml}</div>`;
                con.appendChild(div);
            });
            con.scrollTop = con.scrollHeight;
        }

        function escapeHtml(text) {
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, "<br>");
        }

        // === å¤šåª’ä½“å‘é€ ===
        
        // 1. å‘é€é€»è¾‘ (æ–‡æœ¬/å›¾ç‰‡é€šç”¨)
        async function sendMsg(extraContent = null) {
            const input = document.getElementById('msg-input');
            const txt = input.value.trim();
            
            // å¦‚æœæ—¢æ²¡æœ‰å­—ï¼Œä¹Ÿæ²¡æœ‰å›¾ç‰‡/æ–‡ä»¶é™„ä»¶
            if(!txt && !extraContent) return;
            if(!curChatId) return;

            const charIndex = characters.findIndex(c => c.id === curChatId);
            const char = characters[charIndex];

            // æ„é€ æ¶ˆæ¯ä½“
            const newMessage = { role: 'user', content: [] };
            
            // å®ƒæ˜¯å›¾ç‰‡å—ï¼Ÿ
            if(extraContent && extraContent.type === 'image') {
                // å¦‚æœæœ‰æ–‡å­—ï¼Œå…ˆåŠ æ–‡å­—
                if(txt) newMessage.content.push({ type: 'text', text: txt });
                // å†åŠ å›¾ç‰‡
                newMessage.content.push({ type: 'image_url', image_url: { url: extraContent.data } });
            } else {
                // çº¯æ–‡æœ¬æˆ–è€…æ–‡æœ¬æ–‡ä»¶å†…å®¹
                let finalTxt = txt;
                if(extraContent && extraContent.type === 'file') {
                    finalTxt = (txt ? txt + '\n\n' : '') + `ã€æ–‡ä»¶: ${extraContent.name}ã€‘\n${extraContent.data}`;
                }
                newMessage.content.push({ type: 'text', text: finalTxt });
            }

            // æœ¬åœ°ä¿å­˜å¹¶æ¸²æŸ“
            char.messages.push(newMessage);
            localStorage.setItem('characters', JSON.stringify(characters));
            renderMsg(char);
            
            input.value = '';
            document.getElementById('tools-panel').classList.remove('open');

            // --- å‘é€ç»™ API ---
            const con = document.getElementById('msg-container');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'msg-row ai';
            loadingDiv.innerHTML = `<div class="msg-bubble">Thinking...</div>`;
            con.appendChild(loadingDiv);
            con.scrollTop = con.scrollHeight;

            try {
                if(!settings.apiKey) throw new Error('Key æœªé…ç½®');
                
                // å‡†å¤‡ä¸Šä¸‹æ–‡ (å¤„ç†å¤šæ¨¡æ€çš„æ¶ˆæ¯ç»“æ„ç»™API)
                const history = [
                    { role: 'system', content: char.prompt },
                    ...char.messages.slice(-6) // å‘é€æœ€è¿‘6æ¡ï¼Œé˜²æ­¢å›¾ç‰‡å¸¦å¤ªå¤šå¤ªè´¹Token
                ].map(msg => {
                    // ç¡®ä¿ç»™APIçš„æ ¼å¼æ˜¯å®ƒèƒ½åƒçš„
                    if(Array.isArray(msg.content)) {
                        // å¦‚æœæ˜¯çº¯æ–‡å­—æ•°ç»„ï¼Œè½¬å›å­—ç¬¦ä¸²ä»¥é˜²æŸäº›å¼±æ™ºæ¨¡å‹æŠ¥é”™ï¼Ÿä¸éœ€è¦ï¼ŒOpenAIæ ¼å¼æ ‡å‡†æ”¯æŒæ•°ç»„
                        return msg;
                    } 
                    // æ—§æ•°æ®æ˜¯å­—ç¬¦ä¸²ï¼Œä¸ºäº†ä¿é™©ï¼Œè½¬ä¸ºæ ‡å‡†ç»“æ„
                    return { role: msg.role, content: [{ type:'text', text: msg.content }] };
                });

                const res = await fetch(settings.apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.apiKey}` },
                    body: JSON.stringify({ model: settings.modelName, messages: history })
                });

                if(!res.ok) {
                    const errData = await res.json();
                    throw new Error(errData.error?.message || 'è¯·æ±‚å¤±è´¥');
                }
                const data = await res.json();
                const reply = data.choices[0].message.content;

                con.removeChild(loadingDiv);
                char.messages.push({ role: 'assistant', content: reply }); // AIå›å¤å­˜ä¸ºç®€å•å­—ç¬¦ä¸²å³å¯
                localStorage.setItem('characters', JSON.stringify(characters));
                renderMsg(char);

            } catch(e) {
                loadingDiv.innerHTML = `<div class="msg-bubble" style="color:red">Error: ${e.message}</div>`;
            }
        }

        // 2. é€‰æ‹©æ–‡ä»¶é€»è¾‘
        function triggerFile(type) {
            if(type === 'image') document.getElementById('file-input-image').click();
            if(type === 'file') document.getElementById('file-input-file').click();
        }

        // å¤„ç†å›¾ç‰‡
        function handleImageSelect(e) {
            const file = e.target.files[0];
            if(!file) return;
            
            // å‹ç¼©å›¾ç‰‡ (LocalStorageé™åˆ¶5MBï¼Œå¿…é¡»å‹)
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.getElementById('compress-canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // é™åˆ¶æœ€å¤§å®½é«˜ 800px
                    let w = img.width, h = img.height;
                    const max = 800;
                    if(w > max || h > max) {
                        if(w > h) { h *= max/w; w = max; }
                        else { w *= max/h; h = max; }
                    }
                    
                    canvas.width = w; canvas.height = h;
                    ctx.drawImage(img, 0, 0, w, h);
                    
                    // å‹ç¼©ä¸º jpeg 0.7
                    const base64 = canvas.toDataURL('image/jpeg', 0.6);
                    // å‘é€ï¼
                    sendMsg({ type: 'image', data: base64 });
                }
                img.src = event.target.result;
            }
            reader.readAsDataURL(file);
            e.target.value = ''; // æ¸…ç©ºé˜²æ­¢ä¸èƒ½é‡å¤é€‰
        }

        // å¤„ç†æ–‡ä»¶ (è¯»å–æ–‡æœ¬)
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const text = event.target.result;
                // ç›´æ¥æŠŠå†…å®¹ä½œä¸ºæ–‡æœ¬å‘é€
                sendMsg({ type: 'file', name: file.name, data: text });
            }
            // åªè¯»å–æ–‡æœ¬
            reader.readAsText(file);
            e.target.value = '';
        }
        
        // ç®€æ˜“å¤§å›¾é¢„è§ˆ
        function showBigImg(src) {
            const win = window.open("");
            win.document.write(`<img src="${src}" style="width:100%">`);
        }

        // === API é…ç½®é€»è¾‘ ===
        function saveSettings() {
            settings.apiUrl = document.getElementById('api-url').value.trim();
            settings.apiKey = document.getElementById('api-key').value.trim();
            settings.modelName = document.getElementById('model-name').value.trim();
            localStorage.setItem('settings', JSON.stringify(settings));
            alert('ä¿å­˜æˆåŠŸ');
            goHome();
        }

        async function fetchModels() {
            const btn = document.getElementById('fetch-models-btn');
            const apiUrlInput = document.getElementById('api-url').value.trim();
            const apiKeyInput = document.getElementById('api-key').value.trim();
            if(!apiUrlInput || !apiKeyInput) return alert('è¯·å…ˆå¡«å†™ API åœ°å€å’Œ Key');

            btn.innerText = '...'; btn.disabled = true;
            try {
                 let baseUrl = apiUrlInput.replace(/\/chat\/completions\/?$/, '') + '/models';
                 if(apiUrlInput.endsWith('/v1')) baseUrl = apiUrlInput + '/models';
                 
                 const res = await fetch(baseUrl, { headers: { 'Authorization': `Bearer ${apiKeyInput}` } });
                 if(!res.ok) throw new Error('Fail');
                 const data = await res.json();
                 const models = data.data || [];
                 if(!models.length) throw new Error('No models');

                 const wrapper = document.getElementById('model-input-wrapper');
                 const cur = document.getElementById('model-name').value;
                 wrapper.innerHTML = `<select class="setting-input" id="model-name" style="margin:0">${models.map(m=>`<option value="${m.id}">${m.id}</option>`).join('')}</select>`;
                 if(cur) document.getElementById('model-name').value = cur;
                 alert(`è·å–æˆåŠŸ: ${models.length} ä¸ªæ¨¡å‹`);
            } catch(e) {
                alert('è·å–å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥');
            } finally {
                btn.innerText = 'ğŸ”„ è·å–'; btn.disabled = false;
            }
        }
    </script>
</body>
</html>