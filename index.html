<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„è™šæ‹Ÿæ‰‹æœº</title>
    <style>
        :root {
            --primary-color: #007AFF;
            --desktop-bg: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            height: 100vh;
            overflow: hidden;
            background: #000;
        }

        /* === 1. æ¡Œé¢å±‚ === */
        .desktop-layer {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--desktop-bg);
            z-index: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        /* çŠ¶æ€æ æ—¶é—´ */
        .status-widget {
            margin-top: 40px;
            text-align: center;
            color: #333;
            text-shadow: 0 1px 2px rgba(255,255,255,0.5);
        }
        .clock-time { font-size: 64px; font-weight: 200; }
        .clock-date { font-size: 18px; margin-top: 5px; }

        /* åº”ç”¨å›¾æ ‡ç½‘æ ¼ */
        .app-grid {
            margin-top: 40px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .app-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        
        .app-item:active .app-icon { transform: scale(0.9); filter: brightness(0.8); }

        .app-icon {
            width: 60px;
            height: 60px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            background: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }

        .icon-chat { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; }
        .icon-settings { background: linear-gradient(135deg, #434343 0%, black 100%); color: white; }
        
        .app-name { font-size: 12px; color: #333; text-shadow: 0 1px 1px white; }

        /* === 2. åº”ç”¨çª—å£å±‚ (å¦‚èŠå¤©åˆ—è¡¨ã€è®¾ç½®é¡µ) === */
        .app-window {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #F2F2F7;
            z-index: 10;
            display: flex;
            flex-direction: column;
            transform: translateY(100%); /* é»˜è®¤è—åœ¨ä¸‹é¢ */
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .app-window.open { transform: translateY(0); }

        /* é¡¶éƒ¨å¯¼èˆªæ¡ */
        .nav-bar {
            height: 50px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            border-bottom: 1px solid #ddd;
            flex-shrink: 0;
        }
        .nav-title { font-weight: 600; font-size: 17px; }
        .nav-btn { border: none; background: none; color: var(--primary-color); font-size: 16px; font-weight: 500; }

        /* å†…å®¹æ»šåŠ¨åŒº */
        .content-scroll { flex: 1; overflow-y: auto; padding: 15px; }

        /* === 3. èŠå¤©è¯¦æƒ…å±‚ (æœ€ä¸Šå±‚) === */
        .chat-detail-layer {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #fff;
            z-index: 20;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        .chat-detail-layer.open { transform: translateX(0); }

        /* èŠå¤©æ°”æ³¡æ ·å¼ */
        .msg-row { display: flex; margin-bottom: 15px; }
        .msg-row.user { justify-content: flex-end; }
        .msg-bubble { 
            max-width: 80%; padding: 10px 14px; border-radius: 18px; font-size: 16px; word-wrap: break-word;
        }
        .msg-row.ai .msg-bubble { background: #E9E9EB; color: black; border-bottom-left-radius: 4px; }
        .msg-row.user .msg-bubble { background: #007AFF; color: white; border-bottom-right-radius: 4px; }

        /* åº•éƒ¨è¾“å…¥æ¡† */
        .input-bar {
            padding: 10px; background: #f9f9f9; border-top: 1px solid #ddd; display: flex; gap: 10px;
        }
        .chat-input { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #ddd; outline: none; }
        .send-btn { border: none; background: #007AFF; color: white; padding: 0 15px; border-radius: 20px; }

        /* === 4. åˆ—è¡¨ä¸è®¾ç½®æ ·å¼ === */
        .char-item {
            background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px;
            display: flex; align-items: center; gap: 15px;
        }
        .char-avatar { 
            width: 45px; height: 45px; border-radius: 50%; background: #007AFF; color: white; 
            display: flex; align-items: center; justify-content: center; font-size: 20px;
        }
        
        .setting-input {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px;
        }

        /* === 5. æ¨¡æ€æ¡† (åˆ›å»ºè§’è‰²) === */
        .modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 100;
            display: none; align-items: center; justify-content: center;
        }
        .modal.show { display: flex; }
        .modal-box {
            background: white; width: 80%; max-width: 320px; padding: 20px; border-radius: 16px;
        }
        .modal-btns { display: flex; gap: 10px; margin-top: 15px; }
        .modal-btn { flex: 1; padding: 10px; border-radius: 8px; border: none; font-size: 16px; }
        .btn-cancel { background: #f2f2f2; }
        .btn-ok { background: #007AFF; color: white; }

        /* å…¨å±€åº•éƒ¨Homeæ¡ (åƒiPhone) */
        .home-indicator {
            position: fixed; bottom: 8px; left: 50%; transform: translateX(-50%);
            width: 120px; height: 5px; background: rgba(0,0,0,0.2); border-radius: 10px; z-index: 999;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <!-- 1. æ¡Œé¢ -->
    <div class="desktop-layer" id="desktop">
        <div class="status-widget">
            <div class="clock-time" id="clock">12:00</div>
            <div class="clock-date" id="date">1æœˆ1æ—¥ æ˜ŸæœŸä¸€</div>
        </div>
        <div class="app-grid">
            <!-- èŠå¤©å›¾æ ‡ -->
            <div class="app-item" id="icon-chat">
                <div class="app-icon icon-chat">ğŸ’¬</div>
                <div class="app-name">èŠå¤©</div>
            </div>
            <!-- è®¾ç½®å›¾æ ‡ -->
            <div class="app-item" id="icon-settings">
                <div class="app-icon icon-settings">âš™ï¸</div>
                <div class="app-name">è®¾ç½®</div>
            </div>
        </div>
        <div class="home-indicator"></div>
    </div>

    <!-- 2. åº”ç”¨ï¼šèŠå¤©åˆ—è¡¨ -->
    <div class="app-window" id="app-chat-list">
        <div class="nav-bar">
            <button class="nav-btn" onclick="goHome()">è¿”å›æ¡Œé¢</button>
            <div class="nav-title">æ¶ˆæ¯</div>
            <button class="nav-btn" onclick="showModal()">+</button>
        </div>
        <div class="content-scroll" id="char-list-container"></div>
    </div>

    <!-- 3. åº”ç”¨ï¼šè®¾ç½® -->
    <div class="app-window" id="app-settings">
        <div class="nav-bar">
            <button class="nav-btn" onclick="goHome()">è¿”å›æ¡Œé¢</button>
            <div class="nav-title">è®¾ç½®</div>
            <div></div>
        </div>
        <div class="content-scroll">
            <p style="color:#666; margin-bottom:5px">API åœ°å€</p>
            <input type="text" class="setting-input" id="api-url" placeholder="https://api.example.com/...">
            <p style="color:#666; margin-bottom:5px">API Key</p>
            <input type="password" class="setting-input" id="api-key" placeholder="sk-...">
            <p style="color:#666; margin-bottom:5px">æ¨¡å‹åç§°</p>
            <input type="text" class="setting-input" id="model-name" placeholder="gpt-3.5-turbo">
            <button class="modal-btn btn-ok" style="width:100%" onclick="saveSettings()">ä¿å­˜é…ç½®</button>
        </div>
    </div>

    <!-- 4. èŠå¤©è¯¦æƒ…é¡µ (è¦†ç›–åœ¨åˆ—è¡¨ä¹‹ä¸Š) -->
    <div class="chat-detail-layer" id="app-chat-detail">
        <div class="nav-bar">
            <button class="nav-btn" onclick="closeChat()">â® åˆ—è¡¨</button>
            <div class="nav-title" id="chat-title">åå­—</div>
            <button class="nav-btn" onclick="clearChat()" style="font-size:12px">æ¸…ç©º</button>
        </div>
        <div class="content-scroll" id="msg-container"></div>
        <div class="input-bar">
            <input type="text" class="chat-input" id="msg-input" placeholder="å‘æ¶ˆæ¯...">
            <button class="send-btn" onclick="sendMsg()">å‘é€</button>
        </div>
    </div>

    <!-- 5. æ¨¡æ€æ¡† -->
    <div class="modal" id="create-modal">
        <div class="modal-box" onclick="event.stopPropagation()">
            <h3 style="text-align:center; margin-bottom:15px">æ–°è§’è‰²</h3>
            <input type="text" class="setting-input" id="new-name" placeholder="åå­—" onclick="event.stopPropagation()">
            <input type="text" class="setting-input" id="new-prompt" placeholder="äººè®¾/æç¤ºè¯" onclick="event.stopPropagation()">
            <div class="modal-btns">
                <button class="modal-btn btn-cancel" id="btn-cancel">å–æ¶ˆ</button>
                <button class="modal-btn btn-ok" id="btn-create">åˆ›å»º</button>
            </div>
        </div>
    </div>

    <script>
        // === æ•°æ®é€»è¾‘ ===
        let characters = [];
        let curChatId = null;
        let settings = {};

        // === åˆå§‹åŒ– ===
        document.addEventListener('DOMContentLoaded', () => {
            // åŠ è½½æ•°æ®
            characters = JSON.parse(localStorage.getItem('characters') || '[]');
            settings = JSON.parse(localStorage.getItem('settings') || '{"apiUrl":"","apiKey":"","modelName":"gpt-3.5-turbo"}');
            
            // å¡«å……è®¾ç½®
            document.getElementById('api-url').value = settings.apiUrl || '';
            document.getElementById('api-key').value = settings.apiKey || '';
            document.getElementById('model-name').value = settings.modelName || 'gpt-3.5-turbo';

            // å¯åŠ¨æ—¶é’Ÿ
            setInterval(updateClock, 1000);
            updateClock();

            // æ¸²æŸ“åˆ—è¡¨
            renderList();

            // === äº‹ä»¶ç»‘å®š ===
            
            // 1. æ¡Œé¢å›¾æ ‡ç‚¹å‡»
            document.getElementById('icon-chat').onclick = () => openApp('app-chat-list');
            document.getElementById('icon-settings').onclick = () => openApp('app-settings');

            // 2. æ¨¡æ€æ¡†æŒ‰é’® (åŒ…å«é˜²å†’æ³¡)
            document.getElementById('btn-cancel').onclick = (e) => { e.stopPropagation(); hideModal(); };
            document.getElementById('btn-create').onclick = (e) => { e.stopPropagation(); doCreate(); };
            document.getElementById('create-modal').onclick = (e) => { 
                if(e.target.id === 'create-modal') hideModal(); 
            };
        });

        // === å¯¼èˆªé€»è¾‘ ===
        function openApp(appId) {
            document.getElementById(appId).classList.add('open');
            if(appId === 'app-chat-list') renderList();
        }

        function goHome() {
            // å…³é—­æ‰€æœ‰åº”ç”¨çª—å£
            document.querySelectorAll('.app-window').forEach(el => el.classList.remove('open'));
            // åŒæ—¶å…³é—­é€šè¿‡è¯¦æƒ…é¡µ
            document.getElementById('app-chat-detail').classList.remove('open');
        }

        // === æ—¶é’Ÿé€»è¾‘ ===
        function updateClock() {
            const now = new Date();
            const h = String(now.getHours()).padStart(2, '0');
            const m = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('clock').innerText = `${h}:${m}`;
            const days = ['æ˜ŸæœŸæ—¥','æ˜ŸæœŸä¸€','æ˜ŸæœŸäºŒ','æ˜ŸæœŸä¸‰','æ˜ŸæœŸå››','æ˜ŸæœŸäº”','æ˜ŸæœŸå…­'];
            document.getElementById('date').innerText = `${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ ${days[now.getDay()]}`;
        }

        // === è§’è‰²ç®¡ç† ===
        function renderList() {
            const list = document.getElementById('char-list-container');
            list.innerHTML = '';
            if(characters.length === 0) {
                list.innerHTML = '<div style="text-align:center;color:#999;margin-top:50px">æš‚æ— è§’è‰²ï¼Œç‚¹å³ä¸Šè§’ + åˆ›å»º</div>';
                return;
            }
            characters.forEach(c => {
                const div = document.createElement('div');
                div.className = 'char-item';
                div.onclick = () => openChat(c.id);
                const lastMsg = c.messages.length > 0 ? c.messages[c.messages.length-1].content : 'æ–°å¯¹è¯';
                div.innerHTML = `
                    <div class="char-avatar">${c.name[0]}</div>
                    <div style="flex:1">
                        <div style="font-weight:600">${c.name}</div>
                        <div style="font-size:13px;color:#888;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;width:200px">${lastMsg}</div>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function showModal() { document.getElementById('create-modal').classList.add('show'); }
        function hideModal() { 
            document.getElementById('create-modal').classList.remove('show'); 
            document.getElementById('new-name').value = '';
            document.getElementById('new-prompt').value = '';
        }

        function doCreate() {
            const name = document.getElementById('new-name').value.trim();
            const prompt = document.getElementById('new-prompt').value.trim();
            if(!name) return alert('è¯·å¡«å†™åå­—');
            
            characters.unshift({ id: Date.now(), name, prompt, messages: [] });
            localStorage.setItem('characters', JSON.stringify(characters));
            renderList();
            hideModal();
        }

        // === èŠå¤©é€»è¾‘ ===
        function openChat(id) {
            curChatId = id;
            const char = characters.find(c => c.id === id);
            document.getElementById('chat-title').innerText = char.name;
            renderMsg(char);
            document.getElementById('app-chat-detail').classList.add('open');
        }

        function closeChat() {
            document.getElementById('app-chat-detail').classList.remove('open');
            curChatId = null;
            renderList(); // åˆ·æ–°åˆ—è¡¨æœ€æ–°æ¶ˆæ¯é¢„è§ˆ
        }

        function renderMsg(char) {
            const con = document.getElementById('msg-container');
            con.innerHTML = '';
            char.messages.forEach(m => {
                const div = document.createElement('div');
                div.className = `msg-row ${m.role === 'user' ? 'user' : 'ai'}`;
                div.innerHTML = `<div class="msg-bubble">${m.content}</div>`;
                con.appendChild(div);
            });
            con.scrollTop = con.scrollHeight;
        }

        function clearChat() {
            if(!confirm('ç¡®å®šæ¸…ç©ºè®°å½•ï¼Ÿ')) return;
            const char = characters.find(c => c.id === curChatId);
            char.messages = [];
            localStorage.setItem('characters', JSON.stringify(characters));
            renderMsg(char);
        }

        async function sendMsg() {
            const input = document.getElementById('msg-input');
            const txt = input.value.trim();
            if(!txt || !curChatId) return;

            const charIndex = characters.findIndex(c => c.id === curChatId);
            const char = characters[charIndex];

            // 1. ä¸Šå±ç”¨æˆ·æ¶ˆæ¯
            char.messages.push({ role:'user', content:txt });
            localStorage.setItem('characters', JSON.stringify(characters));
            renderMsg(char);
            input.value = '';

            // 2. å‡†å¤‡AIå›å¤ - æ’å…¥ä¸€ä¸ªä¸´æ—¶ Loading æ°”æ³¡
            const con = document.getElementById('msg-container');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'msg-row ai';
            loadingDiv.innerHTML = `<div class="msg-bubble">...</div>`;
            con.appendChild(loadingDiv);
            con.scrollTop = con.scrollHeight;

            try {
                if(!settings.apiKey) throw new Error('è¯·å…ˆå»æ¡Œé¢-è®¾ç½®é‡Œå¡«å†™Key');
                
                const history = [{role:'system', content:char.prompt}, ...char.messages.slice(-10)];
                const res = await fetch(settings.apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.apiKey}` },
                    body: JSON.stringify({ model: settings.modelName, messages: history })
                });

                if(!res.ok) throw new Error('è¯·æ±‚å¤±è´¥');
                const data = await res.json();
                const reply = data.choices[0].message.content;

                // æ›¿æ¢ Loading ä¸ºçœŸå®æ¶ˆæ¯
                con.removeChild(loadingDiv);
                char.messages.push({ role:'assistant', content:reply });
                localStorage.setItem('characters', JSON.stringify(characters));
                renderMsg(char);

            } catch(e) {
                loadingDiv.innerHTML = `<div class="msg-bubble" style="color:red">é”™è¯¯: ${e.message}</div>`;
            }
        }

        function saveSettings() {
            settings.apiUrl = document.getElementById('api-url').value.trim();
            settings.apiKey = document.getElementById('api-key').value.trim();
            settings.modelName = document.getElementById('model-name').value.trim();
            localStorage.setItem('settings', JSON.stringify(settings));
            alert('ä¿å­˜æˆåŠŸ');
            goHome();
        }
    </script>
</body>
</html>